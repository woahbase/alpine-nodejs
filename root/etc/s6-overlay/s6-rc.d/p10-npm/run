#!/usr/bin/with-contenv bash
set -e

vecho () { if [ "${S6_VERBOSITY:-1}" -gt 0 ]; then echo "[$0] $@"; fi; }
usercmd () { if [ "X${EUID}" != "X0" ]; then $@; else s6-setuidgid $(ls -ldn . | awk 'NR==1 {print $3":"$4}') $@; fi; }
# uses projectdir perms instead of PUID/PGID

# install these packages using npm, specified on runtime
# set npm cache dir to fix https://stackoverflow.com/questions/59437833
# S6_NPM_PACKAGES=""; # list of packages passed at runtime, if required
if [ -n "${S6_NPM_PACKAGES}" ] \
&& [ "X${EUID}" == "X0" ]; # requires root
then
    vecho "Installing NPM global packages: ${S6_NPM_PACKAGES}";
    HOME=/root \
    npm_config_cache=/root/.npm \
        s6-setuidgid root npm install -g ${S6_NPM_PACKAGES};
fi;

# S6_NPM_PROJECTDIR=""; # path to project passed at runtime, if required
# S6_NPM_LOCAL_PACKAGES=""; # list of packages passed at runtime, if required
if [ -n "${S6_NPM_PROJECTDIR}" ]; then
    if [ ! -d "${S6_NPM_PROJECTDIR}" ]; # ensure exists and accessible by $PUID/$PGID
    then
        vecho "Ensure project-dir exists: ${S6_NPM_PROJECTDIR}";
        mkdir -p ${S6_NPM_PROJECTDIR};
        if [ "X${EUID}" == "X0" ];
        then chown ${S6_USER:-alpine}:${PGID:-1000} ${S6_NPM_PROJECTDIR};
        fi;
    fi;

    if [ -f "${S6_NPM_PROJECTDIR}/package.json" ] \
    || [ -f "${S6_NPM_PROJECTDIR}/package-lock.json" ] \
    || [ -f "${S6_NPM_PROJECTDIR}/npm-shrinkwrap.json" ];
    then
        vecho "Installing NPM dependencies for: ${S6_NPM_PROJECTDIR}";
        cd ${S6_NPM_PROJECTDIR} \
        && npm_config_cache=${S6_NPM_PROJECTDIR}/.npm \
        usercmd \
            npm install;
    fi;
    if [ -n "${S6_NPM_LOCAL_PACKAGES}" ];
    then
        vecho "Installing NPM project-local packages: ${S6_NPM_LOCAL_PACKAGES}";
        cd ${S6_NPM_PROJECTDIR} \
        && npm_config_cache=${S6_NPM_PROJECTDIR}/.npm \
        usercmd \
            npm install ${S6_NPM_LOCAL_PACKAGES};
    fi;
    # optionally add user package binaries dir to PATH
    # visible to with-contenv
    if [ -z "${NODEJS_SKIP_MODIFY_PATH}" ] \
    && [[ "${PATH}" != *${S6_NPM_PROJECTDIR}/node_modules/.bin* ]];
    # && ls -A "${S6_NPM_PROJECTDIR}/node_modules/.bin" 1>/dev/null 2>&1
    # only check if dir exists, instead of checking if dir is empty
    # because it might get populated in a later phase
    then
        vecho "Include project bin directory in \$PATH";
        echo -en "${S6_NPM_PROJECTDIR}/node_modules/.bin:${PATH}" > /run/s6/container_environment/PATH;
    fi;
fi;
